<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Converter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes aurora-1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.1); }
        }
        @keyframes aurora-2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-20px, 10px) scale(1.2); }
        }
        @keyframes aurora-3 {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            50% { transform: translate(10px, 10px) scale(0.9); opacity: 0.6; }
        }
        .animate-aurora-1 { animation: aurora-1 10s infinite ease-in-out; }
        .animate-aurora-2 { animation: aurora-2 12s infinite ease-in-out; }
        .animate-aurora-3 { animation: aurora-3 8s infinite ease-in-out; }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
    </style>
</head>
<body class="relative min-h-screen bg-slate-950 text-slate-200 font-sans p-6 flex flex-col items-center justify-center overflow-hidden selection:bg-indigo-500/30 selection:text-indigo-100">

    <!-- Aurora Background Effects -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-indigo-600/20 rounded-full blur-[100px] animate-aurora-1"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cyan-600/20 rounded-full blur-[100px] animate-aurora-2"></div>
        <div class="absolute top-[40%] left-[40%] w-[30%] h-[30%] bg-fuchsia-600/10 rounded-full blur-[100px] animate-aurora-3"></div>
        <div class="absolute inset-0 opacity-[0.03] bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
    </div>

    <div class="w-full max-w-5xl space-y-8 relative z-10">
        
        <!-- Header Section -->
        <div id="main-header" class="text-center space-y-6 pt-4 transition-all duration-500">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 shadow-[0_0_15px_rgba(255,255,255,0.05)] mb-2 animate-fade-in-up backdrop-blur-md">
                <i data-lucide="sparkles" class="w-3.5 h-3.5 text-cyan-300"></i>
                <span class="text-[11px] uppercase tracking-[0.2em] font-bold text-cyan-300/90">Optimized for NotebookLM</span>
            </div>
            
            <div id="header-content">
                <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight text-white leading-tight drop-shadow-2xl animate-fade-in-up" style="animation-delay: 0.1s">
                    静止したスライドを、<br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-indigo-300 to-fuchsia-300">自在なビジュアルへ。</span>
                </h1>
                <p class="text-slate-400 text-lg md:text-xl max-w-2xl mx-auto font-light leading-relaxed animate-fade-in-up mt-6" style="animation-delay: 0.2s">
                    PDFを瞬時に<span class="text-indigo-200 font-medium">高解像度で画像化</span>し、PowerPointやGIFに再構築。<br class="hidden md:block"/>
                    並べ替えも、シェアも、あなたの思いのままに。
                </p>
            </div>
        </div>

        <!-- Glassmorphism Main Card Container -->
        <div id="card-container" class="transition-all duration-500">
            
            <!-- Upload Area -->
            <div id="view-upload" class="bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden relative">
                <div id="drop-zone" class="relative p-24 text-center cursor-pointer group transition-all duration-500 hover:bg-white/5">
                    <input type="file" id="file-input" class="hidden" accept="application/pdf" />
                    <div id="drop-border" class="absolute inset-6 rounded-[1.5rem] border border-dashed transition-all duration-500 border-slate-600/50 group-hover:border-slate-500/80"></div>
                    <div class="relative z-10 flex flex-col items-center gap-8">
                        <div id="drop-icon-bg" class="w-24 h-24 rounded-3xl flex items-center justify-center shadow-2xl transition-all duration-500 border border-white/10 bg-slate-800/50 text-cyan-300 group-hover:scale-105 group-hover:bg-slate-800/80">
                            <i data-lucide="file-text" class="w-10 h-10"></i>
                        </div>
                        <div class="space-y-3">
                            <p class="text-2xl font-bold text-slate-200 group-hover:text-white transition-colors">
                                PDFファイルをここにドロップ
                            </p>
                            <p class="text-sm text-slate-500 group-hover:text-slate-400">
                                または <span class="text-cyan-300 underline decoration-cyan-900 underline-offset-4 group-hover:decoration-cyan-400 transition-all">ファイルを選択</span>
                            </p>
                        </div>
                        <div id="init-loader" class="inline-flex items-center gap-2 px-4 py-2 bg-black/20 border border-white/5 text-slate-400 text-xs font-medium rounded-full mt-4 backdrop-blur-sm">
                            <i data-lucide="loader-2" class="w-3 h-3 animate-spin text-cyan-400"></i> System Initializing...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing View -->
            <div id="view-processing" class="hidden bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden p-24 flex flex-col items-center justify-center min-h-[500px]">
                <div class="relative w-48 h-48 mb-10">
                    <div class="absolute inset-0 bg-indigo-500/20 blur-3xl rounded-full animate-pulse"></div>
                    <svg class="w-full h-full rotate-[-90deg] relative z-10" viewBox="0 0 100 100">
                        <circle class="text-slate-800/50 stroke-current" stroke-width="2" cx="50" cy="50" r="46" fill="transparent"></circle>
                        <circle 
                            id="progress-circle"
                            class="text-cyan-400 stroke-current transition-all duration-300 ease-out drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]" 
                            stroke-width="2" stroke-linecap="round" cx="50" cy="50" r="46" fill="transparent"
                            stroke-dasharray="0 289.02"
                        ></circle>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center z-20">
                        <span id="progress-percent" class="text-5xl font-black text-white tracking-tighter drop-shadow-lg">0%</span>
                    </div>
                </div>
                <h3 id="progress-title" class="text-2xl font-bold text-white mb-2 tracking-wide animate-pulse">
                    CONVERTING SLIDES...
                </h3>
                <p id="progress-message" class="text-indigo-200/60 font-mono text-sm mb-10">Analyzing Structure...</p>
                <button id="btn-cancel" class="text-slate-500 hover:text-white text-xs tracking-widest font-bold px-8 py-3 rounded-full hover:bg-white/10 border border-transparent hover:border-white/10 transition-all backdrop-blur-md">
                    CANCEL
                </button>
            </div>

            <!-- Completion View -->
            <div id="view-complete" class="hidden flex-col items-center w-full animate-fade-in-up">
                
                <!-- Compact Header Info -->
                <div class="text-center mb-8 w-full">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-full text-emerald-400 mb-4 backdrop-blur-md">
                        <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                        <span class="text-sm font-bold tracking-wide">Ready to Download</span>
                    </div>
                    <h2 id="filename-display" class="text-2xl md:text-3xl font-bold text-white mb-2 drop-shadow-lg line-clamp-1 px-4">document.pdf</h2>
                    <div class="flex items-center justify-center gap-4 text-sm text-slate-400 font-mono">
                        <span id="slides-count" class="bg-white/5 px-3 py-1 rounded-md border border-white/5">0 Slides</span>
                        <span id="zip-size" class="bg-white/5 px-3 py-1 rounded-md border border-white/5">0.0 MB</span>
                    </div>
                </div>

                <!-- Action Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                    
                    <!-- PNG (ZIP) -->
                    <button id="btn-download-zip" class="group relative col-span-1 md:col-span-2 p-6 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] hover:bg-slate-700/60 hover:border-cyan-500/30 transition-all duration-300 text-left overflow-hidden shadow-lg hover:shadow-cyan-500/20">
                        <div class="absolute top-0 right-0 p-32 bg-cyan-500/10 rounded-full blur-3xl group-hover:bg-cyan-400/20 transition-all duration-500 translate-x-1/2 -translate-y-1/2"></div>
                        <div class="flex items-start justify-between relative z-10">
                            <div class="space-y-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="p-2 bg-cyan-500/20 rounded-lg text-cyan-300 border border-cyan-500/20 shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                                        <i data-lucide="file-archive" class="w-5 h-5"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-cyan-300/80 uppercase tracking-wider border border-cyan-500/20 px-2 py-0.5 rounded-full bg-cyan-500/5">Recommended</span>
                                </div>
                                <h4 class="text-2xl font-bold text-white group-hover:text-cyan-50 transition-colors">PNG Images (ZIP)</h4>
                                <p class="text-sm text-slate-400 group-hover:text-slate-300">全てのページを個別の高解像度画像として一括保存</p>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-cyan-500 group-hover:text-white transition-all shadow-inner border border-white/5">
                                <i data-lucide="download" class="w-6 h-6"></i>
                            </div>
                        </div>
                    </button>

                    <!-- PPTX -->
                    <button id="btn-pptx" class="group relative p-6 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] hover:bg-slate-700/60 hover:border-orange-500/30 transition-all duration-300 text-left overflow-hidden shadow-lg hover:shadow-orange-500/20 disabled:opacity-50 disabled:cursor-not-allowed">
                        <div class="absolute bottom-0 left-0 p-20 bg-orange-500/10 rounded-full blur-3xl group-hover:bg-orange-400/20 transition-all duration-500 -translate-x-1/3 translate-y-1/3"></div>
                        <div class="flex flex-col h-full justify-between relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div id="pptx-icon-box" class="p-2 bg-orange-500/20 rounded-lg text-orange-300 border border-orange-500/20 shadow-[0_0_15px_rgba(249,115,22,0.3)]">
                                    <i data-lucide="presentation" class="w-5 h-5"></i>
                                </div>
                                <div id="pptx-dl-box">
                                    <div class="bg-white/5 p-1.5 rounded-full group-hover:bg-orange-500/20 group-hover:text-orange-300 transition-colors">
                                        <i data-lucide="download" class="w-4 h-4 text-slate-500"></i>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-white mb-0.5 group-hover:text-orange-50 transition-colors">PowerPoint</h4>
                                <p class="text-[11px] text-slate-400">画像貼り付け済みスライド (PPTX)</p>
                            </div>
                        </div>
                    </button>

                    <!-- GIF & Long PNG Cell -->
                    <div class="flex flex-col gap-4">
                        <!-- GIF -->
                        <div class="group relative p-4 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] hover:bg-slate-700/60 hover:border-fuchsia-500/30 transition-all duration-300 overflow-hidden shadow-lg hover:shadow-fuchsia-500/20 flex items-center justify-between">
                            <div class="flex items-center gap-3 relative z-10">
                                <div id="gif-icon-box" class="p-2 bg-fuchsia-500/20 rounded-lg text-fuchsia-300 border border-fuchsia-500/20 shadow-[0_0_15px_rgba(217,70,239,0.3)]">
                                    <i data-lucide="film" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-white group-hover:text-fuchsia-50 transition-colors">GIF Animation</h4>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <select id="gif-interval" class="text-[10px] bg-black/30 border border-white/10 rounded px-1.5 py-0.5 text-slate-300 focus:outline-none hover:bg-black/50 cursor-pointer">
                                            <option value="0.5">0.5s</option>
                                            <option value="1.0" selected>1.0s</option>
                                            <option value="2.0">2.0s</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button id="btn-gif" class="relative z-10 text-[10px] font-bold bg-white/5 text-slate-300 border border-white/5 px-4 py-2 rounded-full hover:bg-fuchsia-500 hover:text-white hover:border-fuchsia-400 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                CREATE
                            </button>
                        </div>

                        <!-- Long PNG -->
                        <button id="btn-long-img" class="group relative p-4 bg-slate-800/40 backdrop-blur-xl border border-white/10 rounded-[1.5rem] hover:bg-slate-700/60 hover:border-blue-500/30 transition-all duration-300 overflow-hidden shadow-lg hover:shadow-blue-500/20 flex items-center justify-between text-left disabled:opacity-50 disabled:cursor-not-allowed flex-1">
                            <div class="flex items-center gap-3 relative z-10">
                                <div id="long-icon-box" class="p-2 bg-blue-500/20 rounded-lg text-blue-300 border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                                    <i data-lucide="scroll-text" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <h4 class="text-sm font-bold text-white group-hover:text-blue-50 transition-colors">Long PNG</h4>
                                    <p class="text-[10px] text-slate-400">縦読みスクロール</p>
                                </div>
                            </div>
                            <div id="long-dl-box" class="relative z-10">
                                <div class="bg-white/5 p-1.5 rounded-full group-hover:bg-blue-500/20 group-hover:text-blue-300 transition-colors">
                                    <i data-lucide="download" class="w-4 h-4 text-slate-500"></i>
                                </div>
                            </div>
                        </button>
                    </div>

                </div>
                
                <button id="btn-reset-complete" class="mt-8 text-slate-500 hover:text-white flex items-center gap-2 text-xs font-bold tracking-widest uppercase hover:underline decoration-slate-600 underline-offset-4 transition-colors relative z-10">
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Start Over
                </button>

            </div>

            <!-- Error View -->
            <div id="view-error" class="hidden bg-white/5 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden p-20 text-center space-y-6">
                <div class="w-20 h-20 bg-red-900/20 border border-red-500/20 text-red-500 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(239,68,68,0.1)] backdrop-blur-md">
                    <i data-lucide="x" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-200">System Error</h3>
                <p id="error-message" class="text-slate-500 max-w-md mx-auto">エラーが発生しました</p>
                <button id="btn-reset-error" class="px-8 py-3 bg-white/10 text-white border border-white/10 rounded-xl hover:bg-white/20 transition-all font-medium shadow-lg backdrop-blur-md">
                    RETRY
                </button>
            </div>

        </div>
        
        <!-- Footer info -->
        <div class="flex flex-col items-center justify-center space-y-3 pt-8 pb-4 opacity-40 hover:opacity-100 transition-opacity">
            <div class="flex items-center gap-3 text-[10px] font-bold text-slate-500 tracking-[0.2em] uppercase">
                <div class="flex items-center gap-1">
                    <i data-lucide="zap" class="w-3 h-3"></i>
                    <span>Client-Side Processing</span>
                </div>
                <span class="w-1 h-1 rounded-full bg-slate-600"></span>
                <span>No Uploads</span>
            </div>
            <p class="text-xs font-medium text-slate-600">
                Developed by <span class="text-cyan-600/80">majin</span>
            </p>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        // 外部ライブラリの読み込みヘルパー
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.body.appendChild(script);
            });
        };

        // --- State Variables ---
        let currentFile = null;
        let generatedImages = [];
        let zipBlob = null;
        let cancelProcessing = false;
        let librariesLoaded = false;

        // --- DOM Elements ---
        const views = {
            upload: document.getElementById('view-upload'),
            processing: document.getElementById('view-processing'),
            complete: document.getElementById('view-complete'),
            error: document.getElementById('view-error')
        };
        const mainHeader = document.getElementById('main-header');
        const headerContent = document.getElementById('header-content');
        const cardContainer = document.getElementById('card-container');
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            try {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js');
                await loadScript('https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js');
                
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
                document.getElementById('init-loader').classList.add('hidden');
                librariesLoaded = true;
            } catch (err) {
                showError('ライブラリの読み込みに失敗しました。リロードしてください。');
            }
            
            setupEventListeners();
        });

        // --- View Controller ---
        function showView(viewName) {
            Object.values(views).forEach(v => {
                v.classList.add('hidden');
                v.classList.remove('flex'); // remove any explicit flex added by toggle
            });
            
            const view = views[viewName];
            if(viewName === 'complete') {
                view.classList.remove('hidden');
                view.classList.add('flex'); // complete view uses flex layout
                mainHeader.classList.add('mb-4');
                headerContent.classList.add('hidden');
                cardContainer.classList.add('max-w-4xl', 'mx-auto');
            } else {
                view.classList.remove('hidden');
                mainHeader.classList.remove('mb-4');
                headerContent.classList.remove('hidden');
                cardContainer.classList.remove('max-w-4xl', 'mx-auto');
            }
            lucide.createIcons();
        }

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            showView('error');
        }

        function updateProgress(percent, message, title = 'CONVERTING SLIDES...') {
            document.getElementById('progress-percent').innerText = `${percent}%`;
            document.getElementById('progress-message').innerText = message;
            document.getElementById('progress-title').innerText = title;
            document.getElementById('progress-circle').style.strokeDasharray = `${289.02 * (percent / 100)} 289.02`;
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const dropIconBg = document.getElementById('drop-icon-bg');
            const dropBorder = document.getElementById('drop-border');

            // Click to open file dialog
            dropZone.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) startProcessing(e.target.files[0]);
            });

            // Drag and Drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('bg-indigo-500/10');
                dropZone.classList.remove('hover:bg-white/5');
                dropBorder.classList.add('border-indigo-400/50', 'bg-indigo-500/5');
                dropBorder.classList.remove('border-slate-600/50', 'group-hover:border-slate-500/80');
                dropIconBg.classList.add('bg-indigo-500', 'text-white', 'scale-110', 'rotate-3', 'shadow-indigo-500/40');
                dropIconBg.classList.remove('bg-slate-800/50', 'text-cyan-300', 'group-hover:scale-105', 'group-hover:bg-slate-800/80');
            });

            const resetDropStyles = () => {
                dropZone.classList.remove('bg-indigo-500/10');
                dropZone.classList.add('hover:bg-white/5');
                dropBorder.classList.remove('border-indigo-400/50', 'bg-indigo-500/5');
                dropBorder.classList.add('border-slate-600/50', 'group-hover:border-slate-500/80');
                dropIconBg.classList.remove('bg-indigo-500', 'text-white', 'scale-110', 'rotate-3', 'shadow-indigo-500/40');
                dropIconBg.classList.add('bg-slate-800/50', 'text-cyan-300', 'group-hover:scale-105', 'group-hover:bg-slate-800/80');
            };

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                resetDropStyles();
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                resetDropStyles();
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    const droppedFile = e.dataTransfer.files[0];
                    if(droppedFile.type === 'application/pdf') {
                        startProcessing(droppedFile);
                    } else {
                        showError('PDFファイルのみ対応しています。');
                    }
                }
            });

            // Actions
            document.getElementById('btn-cancel').addEventListener('click', () => {
                cancelProcessing = true;
                resetApp();
            });
            document.getElementById('btn-reset-complete').addEventListener('click', resetApp);
            document.getElementById('btn-reset-error').addEventListener('click', resetApp);
            
            document.getElementById('btn-download-zip').addEventListener('click', handleDownloadZip);
            document.getElementById('btn-pptx').addEventListener('click', generatePptx);
            document.getElementById('btn-gif').addEventListener('click', generateGif);
            document.getElementById('btn-long-img').addEventListener('click', generateLongImage);
        }

        // --- Core Processing ---
        async function startProcessing(selectedFile) {
            if (!librariesLoaded) return;
            
            currentFile = selectedFile;
            generatedImages = [];
            zipBlob = null;
            cancelProcessing = false;
            
            updateProgress(0, 'Analyzing Structure...', 'CONVERTING SLIDES...');
            showView('processing');
            resetActionButtons();

            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                const pdf = await window.pdfjsLib.getDocument(arrayBuffer).promise;
                const totalPages = pdf.numPages;
                
                updateProgress(0, 'Rendering Slides...', 'CONVERTING SLIDES...');

                const zip = new window.JSZip();
                const folder = zip.folder("images");

                for (let i = 1; i <= totalPages; i++) {
                    if (cancelProcessing) break;
                    
                    const page = await pdf.getPage(i);
                    const scale = 2.0;
                    const viewport = page.getViewport({ scale });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport }).promise;

                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    generatedImages.push({ 
                        id: i, 
                        dataUrl, 
                        name: `slide_${String(i).padStart(2, '0')}.png`, 
                        width: viewport.width, 
                        height: viewport.height 
                    });
                    
                    folder.file(`slide_${String(i).padStart(2, '0')}.png`, blob);
                    
                    const percent = Math.round((i / totalPages) * 100);
                    updateProgress(percent, `${percent}% Complete`);
                    
                    // Allow UI to update
                    await new Promise(r => setTimeout(r, 20));
                }

                if (cancelProcessing) { 
                    resetApp(); 
                    return; 
                }

                updateProgress(100, 'Packaging Assets...', 'PACKAGING...');
                zipBlob = await zip.generateAsync({ type: "blob" });
                
                // Set Complete View Data
                document.getElementById('filename-display').innerText = currentFile.name;
                document.getElementById('slides-count').innerText = `${generatedImages.length} Slides`;
                document.getElementById('zip-size').innerText = `${(zipBlob.size / 1024 / 1024).toFixed(1)} MB`;
                
                showView('complete');

            } catch (err) {
                console.error(err);
                showError('処理中にエラーが発生しました。ファイルを確認してください。');
            }
        }

        // --- Generators and Downloads ---
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleDownloadZip() {
            if (zipBlob && currentFile) {
                downloadFile(zipBlob, `${currentFile.name.replace('.pdf', '')}_slides.zip`);
            }
        }

        async function generatePptx() {
            if (!window.PptxGenJS || generatedImages.length === 0) return;
            
            setButtonStatus('pptx', 'processing');
            
            try {
                const pptx = new window.PptxGenJS();
                const firstImg = generatedImages[0];
                const ratio = firstImg.width / firstImg.height;
                
                if (Math.abs(ratio - 16/9) < 0.1) pptx.layout = 'LAYOUT_16x9';
                else if (Math.abs(ratio - 4/3) < 0.1) pptx.layout = 'LAYOUT_4x3';
                else { 
                    pptx.defineLayout({ name: 'CUSTOM', width: 10, height: 10 / ratio }); 
                    pptx.layout = 'CUSTOM'; 
                }

                for (const imgData of generatedImages) {
                    const slide = pptx.addSlide();
                    slide.addImage({ data: imgData.dataUrl, x: 0, y: 0, w: '100%', h: '100%' });
                }
                
                await pptx.writeFile({ fileName: `${currentFile.name.replace('.pdf', '')}.pptx` });
                setButtonStatus('pptx', 'complete');
            } catch (err) { 
                console.error(err);
                setButtonStatus('pptx', 'idle'); 
                alert('PowerPoint生成中にエラーが発生しました');
            }
        }

        async function generateGif() {
            if (!window.GIF || generatedImages.length === 0) return;
            
            const interval = Number(document.getElementById('gif-interval').value);
            setButtonStatus('gif', 'processing');
            
            try {
                const workerResponse = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                const workerBlob = await workerResponse.blob();
                const workerUrl = URL.createObjectURL(workerBlob);
                
                const gif = new window.GIF({ 
                    workers: 2, 
                    quality: 10, 
                    workerScript: workerUrl, 
                    width: generatedImages[0].width, 
                    height: generatedImages[0].height 
                });

                for (const imgData of generatedImages) {
                    const img = new Image();
                    img.src = imgData.dataUrl;
                    await new Promise(resolve => { img.complete ? resolve() : img.onload = resolve; });
                    gif.addFrame(img, { delay: interval * 1000 });
                }

                gif.on('finished', (blob) => {
                    downloadFile(blob, `${currentFile.name.replace('.pdf', '')}_animation.gif`);
                    setButtonStatus('gif', 'complete');
                    URL.revokeObjectURL(workerUrl);
                });
                
                gif.render();
            } catch (err) { 
                console.error(err);
                setButtonStatus('gif', 'complete'); 
            }
        }

        async function generateLongImage() {
            if (generatedImages.length === 0) return;
            
            setButtonStatus('longImg', 'processing');
            
            try {
                const maxWidth = Math.max(...generatedImages.map(img => img.width));
                const totalHeight = generatedImages.reduce((sum, img) => sum + img.height, 0);
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = maxWidth;
                canvas.height = totalHeight;
                
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                let currentY = 0;
                
                for (const imgData of generatedImages) {
                    const img = new Image();
                    img.src = imgData.dataUrl;
                    await new Promise(resolve => { img.complete ? resolve() : img.onload = resolve; });
                    const x = (maxWidth - imgData.width) / 2;
                    ctx.drawImage(img, x, currentY);
                    currentY += imgData.height;
                }
                
                canvas.toBlob((blob) => {
                    if (blob) {
                        downloadFile(blob, `${currentFile.name.replace('.pdf', '')}_long.png`);
                        setButtonStatus('longImg', 'complete');
                    } else {
                        setButtonStatus('longImg', 'idle');
                    }
                }, 'image/png');
            } catch (err) { 
                console.error(err);
                setButtonStatus('longImg', 'idle'); 
            }
        }

        // --- UI Helpers ---
        function setButtonStatus(type, status) {
            if (type === 'pptx') {
                const btn = document.getElementById('btn-pptx');
                const iconBox = document.getElementById('pptx-icon-box');
                const dlBox = document.getElementById('pptx-dl-box');
                
                if (status === 'processing') {
                    btn.disabled = true;
                    iconBox.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
                } else if (status === 'complete') {
                    btn.disabled = false;
                    iconBox.innerHTML = '<i data-lucide="presentation" class="w-5 h-5"></i>';
                    dlBox.innerHTML = '<div class="bg-emerald-500/20 text-emerald-400 p-1.5 rounded-full border border-emerald-500/20"><i data-lucide="check-circle-2" class="w-4 h-4"></i></div>';
                } else {
                    btn.disabled = false;
                    iconBox.innerHTML = '<i data-lucide="presentation" class="w-5 h-5"></i>';
                    dlBox.innerHTML = '<div class="bg-white/5 p-1.5 rounded-full group-hover:bg-orange-500/20 group-hover:text-orange-300 transition-colors"><i data-lucide="download" class="w-4 h-4 text-slate-500"></i></div>';
                }
            } 
            else if (type === 'gif') {
                const btn = document.getElementById('btn-gif');
                const iconBox = document.getElementById('gif-icon-box');
                const select = document.getElementById('gif-interval');
                
                if (status === 'processing') {
                    btn.disabled = true;
                    select.disabled = true;
                    iconBox.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                    btn.innerText = 'PROCESSING';
                } else if (status === 'complete') {
                    btn.disabled = false;
                    select.disabled = false;
                    iconBox.innerHTML = '<i data-lucide="film" class="w-4 h-4"></i>';
                    btn.innerText = 'RETRY';
                } else {
                    btn.disabled = false;
                    select.disabled = false;
                    iconBox.innerHTML = '<i data-lucide="film" class="w-4 h-4"></i>';
                    btn.innerText = 'CREATE';
                }
            }
            else if (type === 'longImg') {
                const btn = document.getElementById('btn-long-img');
                const iconBox = document.getElementById('long-icon-box');
                const dlBox = document.getElementById('long-dl-box');
                
                if (status === 'processing') {
                    btn.disabled = true;
                    iconBox.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                } else if (status === 'complete') {
                    btn.disabled = false;
                    iconBox.innerHTML = '<i data-lucide="scroll-text" class="w-4 h-4"></i>';
                    dlBox.innerHTML = '<div class="bg-emerald-500/20 text-emerald-400 p-1 rounded-full"><i data-lucide="check-circle-2" class="w-4 h-4"></i></div>';
                } else {
                    btn.disabled = false;
                    iconBox.innerHTML = '<i data-lucide="scroll-text" class="w-4 h-4"></i>';
                    dlBox.innerHTML = '<div class="bg-white/5 p-1.5 rounded-full group-hover:bg-blue-500/20 group-hover:text-blue-300 transition-colors"><i data-lucide="download" class="w-4 h-4 text-slate-500"></i></div>';
                }
            }
            lucide.createIcons();
        }

        function resetActionButtons() {
            setButtonStatus('pptx', 'idle');
            setButtonStatus('gif', 'idle');
            setButtonStatus('longImg', 'idle');
            document.getElementById('gif-interval').value = '1.0';
        }

        function resetApp() {
            currentFile = null;
            generatedImages = [];
            zipBlob = null;
            cancelProcessing = false;
            document.getElementById('file-input').value = '';
            showView('upload');
        }

    </script>
</body>
</html>
